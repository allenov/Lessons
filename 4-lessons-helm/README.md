# Урок: Основы Helm

Helm — это один из самых мощных инструментов в экосистеме Kubernetes. Это не просто менеджер пакетов, а целый инструмент, который облегчает процесс развертывания, настройки и обновления приложений в Kubernetes-кластере. В этой лекции мы разберем основные возможности Helm, научимся запускать существующие чарты, изменять параметры через `values.yaml`, а также создадим собственный чарт.

---

## 1. Что такое Helm?

Helm — это инструмент для автоматизации и управления развертыванием приложений в Kubernetes. Основной его единицей является **чарт** (chart) — шаблон, который описывает, как должно быть развернуто приложение.

### Зачем нужен Helm?
- **Упрощение развертывания**: с помощью Helm можно легко устанавливать, обновлять и удалять приложения, минимизируя количество рутинных операций.
- **Управление версиями**: Helm позволяет легко обновлять версии приложений, откатываться к предыдущим версиям, поддерживать несколько версий одного и того же приложения.
- **Шаблоны и конфигурация**: Helm использует шаблоны, чтобы динамично генерировать конфигурационные файлы Kubernetes. Это позволяет централизованно управлять параметрами приложений.
- **Управление зависимостями**: автоматическая установка связанных компонентов.

### Основные компоненты Helm:

1. **Chart** — это пакет, который содержит все необходимые файлы и шаблоны для развертывания приложения в Kubernetes. Это своего рода "рецепт" для вашего приложения, включающий описание всех ресурсов (Pod, Service, ConfigMap, и т. д.).

2. **Release** — это конкретная версия чарта, установленная в Kubernetes-кластере. Один чарт может быть установлен несколько раз с разными именами релизов.

3. **Repository** — это место, где хранятся чарт-файлы. Репозитории могут быть публичными, например, Helm Hub, или приватными для внутренних нужд компании.
---

## 2. Установка Helm

Установка Helm состоит из нескольких простых шагов. Для этого нужно просто скачать и установить сам инструмент:

1. Загрузите Helm с [официального сайта](https://helm.sh/docs/intro/install/). Здесь вы найдете инструкции для разных операционных систем.

2. После установки можно проверить, что все прошло успешно, выполнив команду:
   ```bash
   helm version
   ```
   Если установка прошла успешно, вы увидите информацию о версии Helm.

---


## 3. Основные команды Helm

1. **Создание нового чарта:**
   Если вам нужно создать свой собственный чарт, Helm предоставляет команду для этого:
   ```bash
   helm create <chart-name>
   ```
   Это создаст структуру директорий с набором шаблонов, файлов значений и метаинформации.

2. **Добавление официального или стороннего репозитория выполняется командой:**
   ```bash
   helm repo add <repo-name> <repo-url>
   ```
3. **После добавления обновите локальный индекс репозиториев:**
   ```bash
   helm repo update
   ```
4. **Чтобы найти чарт в добавленных репозиториях, используйте команду:**
   ```bash
   helm search repo <query>
   ```
   Пример:
   ```bash
   helm search repo nginx
   ```

   Результат покажет имя чарта, его версию и описание:
   ```
   NAME                    CHART VERSION    APP VERSION    DESCRIPTION
   bitnami/nginx           13.2.5           1.21.6         NGINX is a high performance web server
   ```
5. **Чтобы узнать подробности о чарте, выполните команду**
   ```bash
   helm show chart <chart-name>
   ```
   Пример для чарта NGINX:
   ```bash
   helm show chart bitnami/nginx
   ```
6. **Для ознакомления с доступными параметрами чарта**
   ```bash
   helm show values <chart-name>
   ```
   Пример:
   ```bash
   helm show values bitnami/nginx
   ```
7. **Установка существующего чарта из репозитория**
   ```bash
   helm repo add bitnami https://charts.bitnami.com/bitnami
   helm install my-release bitnami/nginx
   ```
   Здесь:
   - `my-release` — имя релиза.
   - `bitnami/nginx` — чарт Nginx из репозитория Bitnami.

8. **Изменение параметров через values.yaml**\
   Скачайте значения по умолчанию:
   ```bash
   helm show values bitnami/nginx > custom-values.yaml
   ```
   Измените параметры, например:
   ```yaml
   replicaCount: 2
   service:
     type: NodePort
     nodePorts:
       http: 30000
   ```
   Установите чарт с измененными параметрами:
   ```bash
   helm install my-release bitnami/nginx --values custom-values.yaml
   ```
9. **Просмотр установленных релизов:**
   Чтобы увидеть список всех установленных релизов в вашем кластере, используйте:
   ```bash
   helm list
   ```
   Эта команда выводит все текущие релизы с их статусами и версиями.

10. **Обновление чарта:**
   Если нужно обновить приложение до новой версии чарта (например, с новыми параметрами), используйте команду:
   ```bash
   helm upgrade <release-name> <chart-name>
   ```
   Helm автоматически применит изменения и обновит релиз в Kubernetes.

11. **Удаление релиза:**
   Для удаления приложения из Kubernetes нужно выполнить команду:
   ```bash
   helm uninstall <release-name>
   ```
   После этого Helm удалит все связанные ресурсы (Pod, Service и т. д.) из кластера.

---

## 4. Создание собственного чарта

Создадим свой чарт для развертывания Nginx:

1. **Создание структуры чарта:**
   ```bash
   helm create my-nginx
   ```
   В директории `my-nginx` будут следующие папки:
   - `charts/` — зависимости.
   - `templates/` — шаблоны манифестов Kubernetes.
   - `values.yaml` — настройки по умолчанию.

2. **Изменение `values.yaml`:**
   ```yaml
   replicaCount: 2
   image:
     repository: nginx
     tag: stable
   service:
     type: NodePort
     nodePort: 30000
   ```

3. **Пример шаблона Deployment (`templates/deployment.yaml`):**
   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: {{ .Release.Name }}-nginx
   spec:
     replicas: {{ .Values.replicaCount }}
     selector:
       matchLabels:
         app: {{ .Chart.Name }}
     template:
       metadata:
         labels:
           app: {{ .Chart.Name }}
       spec:
         containers:
         - name: nginx
           image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
           ports:
           - containerPort: 80
   ```

4. **Установка чарта:**
   ```bash
   helm install my-nginx ./my-nginx
   ```

5. **Проверка запущенных ресурсов:**
   ```bash
   kubectl get all
   ```


---

## 5. Файл `values.yaml`

Один из самых полезных файлов в чарте — это `values.yaml`. В этом файле хранятся настройки и параметры, которые можно переопределить при установке чарта. Это позволяет легко адаптировать одно и то же приложение под разные окружения (например, продакшн, тесты и локальное окружение).

Пример содержимого `values.yaml`:

```yaml
replicaCount: 3
image:
  repository: nginx
  tag: latest
service:
  type: ClusterIP
  port: 80
ingress:
  enabled: true
  hosts:
    - host: example.com
      paths:
        - path: /
          pathType: ImplementationSpecific
```

Здесь определены:
- **replicaCount** — количество реплик приложения.
- **image** — Docker-образ, который будет использоваться.
- **service** — тип сервиса (например, ClusterIP) и порт.
- **ingress** — настройки для Ingress-ресурса, если он используется.

### Переопределение значений

Вы можете переопределить значения из `values.yaml` при установке чарта, используя флаг `--values`:
   ```bash
   helm install <release-name> <chart-name> --values custom-values.yaml
   ```
В этом случае Helm будет использовать значения из вашего файла `custom-values.yaml`, а не стандартные из `values.yaml`.

Для изменения параметров чарта можно еще использовать флаг `--set` :
   ```bash
   helm install my-nginx bitnami/nginx --namespace web --set service.type=LoadBalancer
   ```
---

## 6. Лучшие практики оптимизации работы с Helm

### 1. **Универсальная команда для установки и обновления чарта**
Часто при установке или обновлении чарта используются отдельные команды, но их можно объединить с помощью `--install`:
   ```bash
   helm upgrade --install <release-name> <chart-name> --namespace <namespace-name> --create-namespace
   ```
Эта команда:
- Установит чарт, если он еще не существует.
- Обновит его, если релиз уже есть.
- Автоматически создаст namespace, если он не существует, благодаря флагу `--create-namespace`.

### 2. **Сначала используйте `helm lint` для проверки чарта**
  ```bash
  helm lint <chart-directory>
  ```

`helm lint` помогает обнаружить синтаксические ошибки, некорректные ссылки на значения и другие потенциальные проблемы в чарт-файлах.

### 2. **Проверка рендеринга перед установкой**
Чтобы убедиться, что все параметры указаны правильно и чарт рендерится корректно:
   ```bash
   helm template <release-name> <chart-name> --values custom-values.yaml
   ```
Это позволяет избежать ошибок при установке.

### 3. **Использование стандартного файла параметров**
Для удобства работы:
- Храните все изменения параметров в отдельном файле, например, `custom-values.yaml`.
- Используйте этот файл для всех операций:
  ```bash
  helm upgrade --install <release-name> <chart-name> --namespace <namespace-name> --values custom-values.yaml --create-namespace
  ```

### 4. **Использование Helm Diff**
Перед применением изменений, особенно в production-средах, важно проверить, как они повлияют на текущую установку. Для этого используйте плагин **Helm Diff**:

1. Установите плагин:
   ```bash
   helm plugin install https://github.com/databus23/helm-diff
   ```

2. Проверьте различия:
   ```bash
   helm diff upgrade <release-name> <chart-name> --namespace <namespace-name>
   ```

Это поможет избежать нежелательных изменений, таких как удаление или изменение критически важных ресурсов.

### 5. **Разделение окружений**
Создавайте отдельные values-файлы для каждого окружения (например, `dev`, `staging`, `prod`) и храните их в системе управления версиями. Это позволяет легко переключаться между окружениями.

Пример структуры файлов:
   ```
   charts/
     values-dev.yaml
     values-staging.yaml
     values-prod.yaml
   ```

Установка чарта для `prod` окружения:
   ```bash
   helm upgrade --install <release-name> <chart-name> -f values-prod.yaml --namespace prod
   ```

#### Использование global.yaml
Если в ваших чартах есть общие параметры, используйте файл `global.yaml` для их хранения. Это позволяет избегать дублирования настроек между окружениями.

Пример структуры:
   ```
   charts/
     global.yaml
     values-dev.yaml
     values-staging.yaml
     values-prod.yaml
   ```

Пример использования:
   ```bash
   helm upgrade --install <release-name> <chart-name> \
     -f global.yaml \
     -f values-prod.yaml \
     --namespace prod
   ```

В этом случае параметры из `global.yaml` будут объединены с параметрами из `values-prod.yaml`. Если одинаковые ключи присутствуют в обоих файлах, приоритет отдается значениям из последнего указанного файла.

### 6. **Проверка состояния релиза**
После установки или обновления релиза проверьте его статус:
   ```bash
   helm status <release-name> --namespace <namespace-name>
   ```

Эти практики помогут избежать распространенных ошибок, ускорить работу и сделать управление чартами более удобным и эффективным. Если нужно больше примеров или детализация какого-либо пункта, напишите!

---

## Заключение

Helm — это незаменимый инструмент для работы с Kubernetes, который позволяет автоматизировать развертывание, обновления и управление приложениями. Он предоставляет мощные возможности для организации инфраструктуры, улучшает повторяемость развертываний и значительно упрощает работу с Kubernetes.
